<!DOCTYPE html>
<html lang="en">
<head><meta content="width=device-width, initial-scale=1" name="viewport"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/ui-lightness/jquery-ui.css" rel="stylesheet"/>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>

<style>:root {
    --main-bg-color: #1d4193;
    --side-bg-color: #000066;
    --accent1: #3399ff;
    --accent2: white;
    --accent3: rgb(200, 50, 70);
    --loader-fg: #3498db;
    --loader-bg: #f3f3f3;
}


/* Generic Styling{{{*/
*{
    box-sizing: border-box;
}
body {
    font-family: 'Montserrat', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--main-bg-color);
    color: var(--accent2);
    display: flex;
    justify-content: center;
    margin-left: 5%;
    margin-right: 5%;
}

h2 {
    text-align: center;
    margin-top: 0px;
}
h3 {
    margin-bottom: 20px; 
}


button {
    cursor: pointer;
    width: 100%;
    height: 40px;
    background-color: var(--accent3);
    font-weight: normal;
    color: var(--accent2);
    border: 0px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 20px;
    margin-top: 10px;
}

label {
    display: block;
}
input, textarea, select {
    width: 100%;
    font-size: 20px;
    border-radius: 10px;
    margin-top: 5px;
}/*}}}*/

/* Page Outline{{{*/
#page-content {
    margin: 3em;
    font-size: 20px;
    width: 100%;
    text-align: center;
    padding-bottom: 80px;
}
.page {
    display: none;
    text-align: center;
}

#header {
    width: 100%;
    border-radius: 10px;
    margin-bottom: 20px;
    padding: 10px;
    cursor: pointer;
    background-color: var(--accent3);
    border: 2px solid black;
    text-align: center;
}
/*}}}*/

/* Search Menu {{{*/
#invoice-search {
    font-size: 16px; /* Increase font-size */
    padding: 12px 10px 12px 10px; /* Add some padding */
    border: 1px solid var(--main-bg-color); /* Add a grey border */
    width: 90%;
}
#invoice-list {
    margin-top: 10px;
    padding: 20px;
    list-style-type: none;
    border-radius: 5px;
    text-align: left;
    overflow: auto;
    max-height: 400px;
    scrollbar-width: none;
}
#invoice-list li {
    border: 1px solid var(--main-bg-color);
    margin-bottom: 20px;
    background-color: var(--accent3);
    padding: 12px;
    font-size: 18px;
    color: black;
    display: block;
    border-radius: 5px;
    cursor: pointer;
}/*}}}*/

/* Grid Edit{{{*/
#grid-editor {
    padding: 3%;
    background-color: var(--side-bg-color);
    margin-bottom: 20px;
    border-radius: 10px;
    text-align: left;
}

#grid-edit-table {
    width: 100%; /* Set the width of the table container */
    overflow-x: auto; /* Enable horizontal scrolling */
}

.gridjs tr {
    color: black;
    border: 1px solid black;
    background-color: var(--accent2);
    margin: 10px;
    padding: 10px;
    text-align: center;
}
.gridjs th {
    color: var(--accent2);
    border: 1px solid black;
    background-color: var(--accent3);
    margin: 10px;
    padding: 10px;
    text-align: center;
}
/*}}}*/

/* Auxilliary Pages {{{*/
#success {
    text-align: center;
    padding: 20px;
}

#loading {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 100px;
}
#loader {
    border: 16px solid var(--loader-bg);
    border-top: 16px solid var(--loader-fg);
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
}



@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}/*}}}*/
</style></head><body onload="startup()">
<div id="page-content">
<div class="page" id="loading">
<div style="display: flex; justify-content: center">
<div id="loader"></div>
</div>
</div>
<div class="page" id="success">
<div style="font-size: 150px">âœ…</div>
<div style="font-size: 30px; margin-bottom: 30px;">Success!</div>
<button class="action" onclick="loadHome()" style="height:40px">Go Back</button>
<button class="action" onclick="redirect()" style="height:40px">Renewance Home</button>
</div>
<div class="page" id="invoice-select">
<h3>Choose an invoice</h3>
<input id="invoice-search" onkeyup="invoiceSearch('invoice-search', 'invoice-list')" placeholder="Search for invoices.." type="text"/>
<ul id="invoice-list">
</ul>
</div>
<div class="page" id="grid-editor">
<h2>Veteran Crane Invoice Editor</h2>
<div id="header" onclick="loadInvoiceSelect()">
<div><strong>Selected invoice:</strong> <span id="invoice-name"></span><br/>(Click to Change)</div>
</div>
<div id="grid-edit-table"></div>
<div id="actions">
<button class="action" onclick="showPage('edit-expense')">+</button>
</div>
</div>
</div>

<script>// Constants {{{
const HEADERS = {
    'QB-Realm-Hostname': 'veterancrane',
    'User-Agent': 'Veteran Crane Invoice Editor',
    'Content-Type': 'application/json'
}
const URLPARAMS = new URLSearchParams(window.location.search);
const OVERRIDE = ""
const SCHEMA = {
    'Invoices': {
        'id': 'bsg43ze29'
    },
    'Activities': {
        'id': 'bsgtctjng'
    },
    'Employees': {
        'id': 'bsext97t8'
    },
}
const LINEFIELDS = {
    "#line-date": 11,
    "#line-activity": 6,
    "#line-description": 19,
    "#line-group": 6,
    "#line-price": 18,
    "#line-vendor-price": 31,
    "#line-qty": 12,
    "#line-target-margin": 32,
}
// }}}
// Global Variables {{{
let invoice = URLPARAMS.get('invoice');
// }}}


// Initialization {{{
function startup() {

    showPage("loading");
    getActivities()
        .then(res => loadGridEditor());

}
// }}}

// Show/hide functionality {{{
function showClassElt(className, id) {
    $("."+className).each(function () {
        $(this).hide();
        if($(this).attr("id") == id) {$(this).show()}
    });
}

function showEditExpense(id) {
    showPage("edit-expense")
    $("#expense-form")[0].reset()
    if(id) {
        showPage("loading");
        getExpense(id).then(res => showPage("edit-expense"));
        expenseId = id;
    }
}

function showPage(newPage) {showClassElt("page", newPage)}
// }}}

// Invoice Selection {{{
function loadInvoiceSelect() {
    showPage("loading");
    getInvoices()
        .then(res => showPage("invoice-select"))
}
function invoiceSearch(input_tag, list_tag) {
    // Declare variables
    var input, filter, ul, li, a, i, txtValue;
    input = $(`#${input_tag}`);
    filter = input.val().toUpperCase();
    ul = $(`#${list_tag}`);
    li = ul.children('li');

    // Loop through all list items, and hide those who don't match the search query
    for (i = 0; i < li.length; i++) {
        txtValue = li[i].textContent || li[i].innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}

function getInvoices() {
    return queryQuickbase({
        "from": SCHEMA["Invoices"]["id"],
        "select": [3,20]
    }).then(resj => handleInvoices(resj["data"]));
}
function handleInvoices(res) {
    let invoicesLst = $("#invoice-list");

    invoicesLst.empty();
    for(let i = 0; i < res.length; i++) {
        let invoiceOpt = $("<li></li>");
        invoiceOpt.val(res[i][3]["value"]);
        invoiceOpt.text(res[i][20]["value"]);

        invoiceOpt.click(() => {
            invoice = res[i][3]["value"];
            loadGridEditor();
        });

        invoicesLst.append(invoiceOpt)

    }
}

function getInvoiceInfo() {
    return queryQuickbase({
        "from": SCHEMA["Invoices"]["id"],
        "select": [20],
        "where": `{3.EX.${invoice}}`,
    }).then(resj => {handleInvoiceInfo(resj["data"])});
}
function handleInvoiceInfo(res) {
    $("#invoice-name").text(res[0][20]["value"]);
}

// }}}

// Grid Editor {{{
function loadGridEditor() {
    if(invoice) {
        getInvoiceInfo()
        grid = new gridjs.Grid({ 
            columns: [
                {name:'Date', width:"100px"}, 
                {name:'Activity', width:"200px"}, 
                {name:'Description', width:"300px"},
                {name:'Group', width:"100px"},
                {name:'Price', width:"100px"},
                {name:'Vendor Price', width:"200px"},
                {name:'QTY', width:"100px"},
                {name:'Target Margin', width:"200px"}],
            data: [],
            resizable: true,
            style: {
                table: {
                    'overflow-x': 'auto' // Make the table scrollable vertically
                }
            }
        });
        grid.render(document.getElementById('grid-edit-table'));
    }
    showPage("grid-editor");
}//}}}

// Line handling {{{

function addLine() {
    let record = {};

    if(expenseId) {
        record["3"] = {"value": expenseId}; // Record ID to modify if applicable
    }

    record["28"] = {"value": invoice}
    record["29"] = {"value": order}
    record["30"] = {"value": employee}
    for(const prop in elt_lookup) {
        record[elt_lookup[prop]] = {"value": $(prop).val()}
    }

    return addRecord(SCHEMA["Lines"]["id"], record)
        .then(res => res.json())
        .then(res => addDocument(res["metadata"]["createdRecordIds"][0]))
        .then(res => {$("#modify-form")[0].reset()})
        .then(res => showPage('success'));
}

function getActivities() {
    return queryQuickbase({
        "from": SCHEMA["Activities"]["id"],
        "select": [3,6],
        "where": "{16.EX.1}"
    }).then(resj => {handleActivities(resj["data"])})
}
function handleActivities(resj) {
    for(var i=0; i<resj.length; i++) {
        var opt = document.createElement("option");
        opt.value = resj[i][3]["value"];
        opt.innerHTML = resj[i][6]["value"];
        $("#activities").append(opt);
    }
}

function getLines() {
    return queryQuickbase({
        "from": SCHEMA["Lines"]["id"],
        "select": [3,9,15,22],
        "where": `{28.EX.${invoice}}AND{30.EX.${employee}}`
    }).then(resj => handleLines(resj["data"]));
}
function handleLines(resj) {
    let list = $("#lines-list");
    list.empty();
    for(let i = 0; i<resj.length; i++) {
        let id = resj[i][3]["value"];
        let expense = $("<div></div>");
        expense.addClass("line-item");
        expense.text(resj[i][9]["value"] + " : " + expenseDate.toLocaleString(
            navigator.language, {
                timeZone: "America/Los_Angeles"
            }
        ).split(',')[0]);

        let buttons = $("<div></div>");
        buttons.addClass("line-btn-set");

        let editExpense = $("<button>Edit Expense</button>");
        editExpense.addClass("expense-btn");
        editExpense.click(() => {showEditExpense(id)});

        buttons.append(editExpense);
        expense.append(buttons);
        list.append(expense);
    }
    if(resj.length == 0) {
        let order = $("<div></div>");
        order.text("No lines for this invoice yet!");
        list.append(order);
    }
}

function loadLinesList() {
    showPage('loading')
    getLines()
        .then(res => showPage('grid-editor'))
}
// }}}

// Quickbase Interface {{{

function addRecord(table, record_data) {
    showPage("loading");
    return authenticatedInstance(table, (key) => {
        let headers = HEADERS;
        headers["Authorization"] = key;

        let body = {
            "to": table,
            "data": [record_data]
        }
        return fetch("https://api.quickbase.com/v1/records", {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        })
    });
}

function queryQuickbase(body) {
    // General query function for quickbase
    return authenticatedInstance(body["from"], (key) => {
        let headers = HEADERS;
        headers["Authorization"] = key;

        return fetch("https://api.quickbase.com/v1/records/query", {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        }).then(res => res.json());
    })
}

function authenticatedInstance(table_id, fun) {
    // Wraps the given function with a temporary authentication key
    if(OVERRIDE) {
        return fun(OVERRIDE);
    }
    return fetch('https://api.quickbase.com/v1/auth/temporary/'+table_id,
        {
            method: 'GET',
            headers: HEADERS,
            credentials: 'include'
        })
        .then(res => res.json())
        .then(resj => fun("QB-TEMP-TOKEN " + resj["temporaryAuthorization"]));
}
// }}}

// Other helpers {{{
function toIsoString(date) {
    let pad = function(num) {
        return (num < 10 ? '0' : '') + num;
    };
    return date.getFullYear() +
        '-' + pad(date.getMonth() + 1) +
        '-' + pad(date.getDate()) +
        'T' + pad(date.getHours()) +
        ':' + pad(date.getMinutes()) +
        ':' + pad(date.getSeconds());
}

function redirect() {
    window.location.replace("https://lift.quickbase.com/db/bt5ywn6kq/");
}
//}}}
</script></body>
</html>
